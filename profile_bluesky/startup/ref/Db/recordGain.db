# The following records are for recording amplifier gains and the MCS channel
# number at which they were changed in the arrays $(P)$(Q)$(A)ampGain,
# $(P)$(Q)$(A)ampReqGain, and $(P)$(Q)$(A)mcsChan.
# The arrays are cleared and then the first point is initialized with MCS
# channel 0 and the amplifier gains at the time $(P)$(Q)$(A)resetGain is executed.
# Once initialized, new values are added whenever $(AMPCTRL)lurange
# or $(AMPCTRL)reqrange post values while $(P)traj1:Execute!=0.
# $(P)$(Q)$(A)ampGain records $(AMPCTRL)lurange
# $(P)$(Q)$(A)ampReqGain records $(AMPCTRL)reqrange
# $(P)$(Q)$(A)mcsChan records $(MCS)CurrentChannel

record(transform, "$(P)$(Q)$(A)resetGain") {
	# We used to be triggered on trajectory build, but the MCS hasn't been erased
	# at that time, so now we're triggered by USAXSfly.db
	#field(INPA, "$(P)traj1:Build CP")

	# It doesn't matter what you write to the RES field of a compress record.
	# Also, RES is handled by special() so you don't want to process.
	field(OUTA, "$(P)$(Q)$(A)ampGain.RES NPP")
	field(OUTB, "$(P)$(Q)$(A)mcsChan.RES NPP")
	field(OUTC, "$(P)$(Q)$(A)ampReqGain.RES NPP")
	# D is zero.  This will be initial MCS channel
	field(OUTD, "$(P)$(Q)$(A)recordGain.B NPP")
	field(INPE, "$(AMPCTRL)lurange")
	field(OUTE, "$(P)$(Q)$(A)recordGain.A NPP")
	field(INPF, "$(AMPCTRL)reqrange")
	field(OUTF, "$(P)$(Q)$(A)recordGain.C NPP")
	field(CLCG, "1")
	field(OUTG, "$(P)$(Q)$(A)recordGain.DISV NPP")
	field(OUTH, "$(P)$(Q)$(A)recordGain.PROC PP")
	field(CLCI, "0")
	field(OUTI, "$(P)$(Q)$(A)recordGain.DISV NPP")
}
record(transform, "$(P)$(Q)$(A)recordGain") {
	field(SDIS, "$(P)traj1:Execute")
	field(DISV, "0")
	field(INPA, "$(AMPCTRL)lurange NPP")
	field(INPB, "$(MCS)CurrentChannel NPP")
	field(INPC, "$(AMPCTRL)reqrange NPP")
	# The next two links are only to get the record processed.  We can't use
	# CP links for INPA, INPB, and INPC, because, at reset time, we need to get
	# the values written to A, B, and C by resetGain, and those values were
	# written with NPP links, so they will not have been posted.
	field(INPD, "$(AMPCTRL)lurange CP")
	field(INPE, "$(AMPCTRL)reqrange CP")
	field(OUTA, "$(P)$(Q)$(A)ampGain.PROC PP")
	field(OUTB, "$(P)$(Q)$(A)mcsChan.PROC PP")
	field(OUTC, "$(P)$(Q)$(A)ampReqGain.PROC PP")
}
record(compress, "$(P)$(Q)$(A)ampGain") {
	field(NSAM, "300")
	field(ALG, "Circular Buffer")
	field(INP, "$(P)$(Q)$(A)recordGain.A")
}
record(compress, "$(P)$(Q)$(A)ampReqGain") {
	field(NSAM, "300")
	field(ALG, "Circular Buffer")
	field(INP, "$(P)$(Q)$(A)recordGain.C")
}
record(compress, "$(P)$(Q)$(A)mcsChan") {
	field(NSAM, "300")
	field(ALG, "Circular Buffer")
	field(INP, "$(P)$(Q)$(A)recordGain.B")
}
